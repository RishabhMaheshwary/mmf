(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{107:function(e,t,n){"use strict";n.d(t,"a",(function(){return m})),n.d(t,"b",(function(){return b}));var r=n(0),a=n.n(r);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function p(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=a.a.createContext({}),c=function(e){var t=a.a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},m=function(e){var t=c(e.components);return a.a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},d=a.a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,l=p(e,["components","mdxType","originalType","parentName"]),m=c(n),d=r,b=m["".concat(s,".").concat(d)]||m[d]||u[d]||o;return n?a.a.createElement(b,i(i({ref:t},l),{},{components:n})):a.a.createElement(b,i({ref:t},l))}));function b(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,s=new Array(o);s[0]=d;var i={};for(var p in t)hasOwnProperty.call(t,p)&&(i[p]=t[p]);i.originalType=e,i.mdxType="string"==typeof e?e:r,s[1]=i;for(var l=2;l<o;l++)s[l]=n[l];return a.a.createElement.apply(null,s)}return a.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},91:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return s})),n.d(t,"metadata",(function(){return i})),n.d(t,"toc",(function(){return p})),n.d(t,"default",(function(){return c}));var r=n(3),a=n(8),o=(n(0),n(107)),s={id:"slurm",title:"Large Scale Hyperparameter Sweeps on Slurm",sidebar_label:"Sweeping on Slurm"},i={unversionedId:"tutorials/slurm",id:"tutorials/slurm",isDocsHomePage:!1,title:"Large Scale Hyperparameter Sweeps on Slurm",description:"MMF provides a utility script for running large scale hyperparameter sweeps on SLURM based cluster setups. A grid search is run on all permutations for the values provided for each of the hyperparameters in the script. The dotlist overrides provided via MMF's configuration system allows to easily override any configuration parameter through this script. This script is created based on sweep scripts provided in FAIRSeq authored by @myleott.",source:"@site/docs/tutorials/slurm.md",slug:"/tutorials/slurm",permalink:"/docs/tutorials/slurm",editUrl:"https://github.com/facebookresearch/mmf/edit/master/website/docs/tutorials/slurm.md",version:"current",lastUpdatedBy:"Amanpreet Singh",lastUpdatedAt:1593555534,sidebar_label:"Sweeping on Slurm",sidebar:"docs",previous:{title:"Adding a Processor",permalink:"/docs/tutorials/processors"},next:{title:"Hateful Memes Challenge",permalink:"/docs/challenges/hateful_memes_challenge"}},p=[],l={toc:p};function c(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(o.b)("wrapper",Object(r.a)({},l,n,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,"MMF provides a utility script for running large scale hyperparameter sweeps on SLURM based cluster setups. A grid search is run on all permutations for the values provided for each of the hyperparameters in the script. The dotlist overrides provided via MMF's configuration system allows to easily override any configuration parameter through this script. This script is created based on sweep scripts provided in FAIRSeq authored by ",Object(o.b)("a",{parentName:"p",href:"https://github.com/myleott"},"@myleott"),"."),Object(o.b)("p",null,"An example script to sweep over learning rate and batch size for MMBT on hateful memes would look like (assuming it is living at ",Object(o.b)("inlineCode",{parentName:"p"},"tools/sweeps/sweep_mmbt_hm.py"),"):"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-py"},'import lib as sweep\n\nfrom lib import hyperparam\n\ndef get_grid(args):\n    # For list of args, run `python tools/sweeps/sweep_mmbt_hm.py --help`.\n\n    return [\n        # Single values (instead of list) remain constant\n        hyperparam("model", "mmbt"),\n        hyperparam("dataset", "hateful_memes"),\n        hyperparam("config", "projects/mmbt/configs/hateful_memes/defaults.yaml"),\n        # Grid sweep for 512 and 256\n        # save_dir_key value is appended to the folder path for easy recognition\n        hyperparam(\n            "training.batch_size", [512, 256], save_dir_key=lambda val: f"bs{val}"\n        ),\n        hyperparam(\n            "optimizer.params.lr", [5e-5, 1e-5], save_dir_key=lambda val: f"lr{val}"\n        ),\n    ]\n    # In the above case, sweep will be run over four combinations of batch\n    # size and lrs, and folder name would mmbt.bsX.lrY.ngpuZ where\n    # number of gpus will be specified via command line argument to this script\n\ndef postprocess_hyperparams(args, config):\n    # Here you can post process a final config that is generated\n    # to adapt some things\n    pass\n\n\n# When directly called through command line, run sweep\'s main function with\n# provided grid configuration\nif __name__ == "__main__":\n    sweep.main(get_grid, postprocess_hyperparams)\n')),Object(o.b)("p",null,"An example command to run this sweep on 2 nodes containing each 8 GPUs each would be:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-sh"},'python tools/sweeps/sweep_mmbt_hm.py:\n--resume_finished \\\n--resume_failed \\\n--checkpoints_dir /home/user/jobs \\\n-t -1 \\\n-g 8 \\\n-n 2 \\\n--constraint some_constraint \\\n--comment "My run" \\\n--partition some_partition \\\n-p my_job\n\n# This will log into folder: /home/user/jobs/my_job.bs512.lr5e-05.ngpu16/\n# for one of the sweeps among 4.\n# Explanation for each of the parameters:\n# --resume_finished: Don\'t skip finished runs, this won\'t run already running jobs\n# --resume_failed: Resume errored out runs from before\n# --checkpoints_dir /home/user/jobs: Directory where log folder will be created\n# -t -1: Run all sweeps, if t=1, run first combination only\n# -g 8: 8 GPUs per node\n# -n 2: 2 Nodes in total\n# --constraint some_constraint: Slurm constraint if any\n# --comment "My run": Slurm comment\n# --partition some_partition: Slurm partition\n# -p my_job: Prefix for log folder\n')),Object(o.b)("div",{className:"admonition admonition-tip alert alert--success"},Object(o.b)("div",{parentName:"div",className:"admonition-heading"},Object(o.b)("h5",{parentName:"div"},Object(o.b)("span",{parentName:"h5",className:"admonition-icon"},Object(o.b)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},Object(o.b)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),Object(o.b)("div",{parentName:"div",className:"admonition-content"},Object(o.b)("p",{parentName:"div"},"Add ",Object(o.b)("inlineCode",{parentName:"p"},"--dry_run")," argument to first print out what exactly is going to be run without actually running it."))),Object(o.b)("p",null,"An actual complex sweep config for visual bert with more options can be found at ",Object(o.b)("a",{parentName:"p",href:"https://github.com/facebookresearch/mmf/blob/master/tools/sweeps/sweep_visual_bert.py"},"./tools/sweep/sweep_visual_bert.py"),". Command following the above command to run it:"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-sh"},'python tools/sweeps/sweep_visual_bert.py \\\n--resume_finished \\\n--resume_failed \\\n--checkpoints_dir /home/user/jobs \\\n-t -1 -g 8 -n 2 --constraint some_constraint \\\n--comment "My run" \\\n--partition some_partition \\\n-p my_job\n')))}c.isMDXComponent=!0}}]);