


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mmf.modules.metrics | MMF 1.0.0rc12 documentation</title>
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-135079836-2"></script>
  <script src="../../../_static/js/ga.js"></script>
  <script src="../../../_static/js/redirect.js"></script>
  
  <link rel="shortcut icon" href="../../../_static/images/favicon.png"/>
  
  
  <link rel="canonical" href="https://mmf.sh/api/_modules/mmf/modules/metrics.html"/>
  
  <meta property="og:title" content="mmf.modules.metrics | MMF 1.0.0rc12 documentation">
  <meta name="description" content="API docs for MMF. MMF is a modular framework powered by PyTorch for multimodal vision and language research from Facebook AI Research">
  <meta property="og:description" content="API docs for MMF. MMF is a modular framework powered by PyTorch for multimodal vision and language research from Facebook AI Research">
  <meta property="og:image" content="https://mmf.sh/img/logo.png">
  <meta property="twitter:image" content="https://mmf.sh/img/logo.png">
  <meta name="twitter:image:alt" content="Image for MMF">
  <meta name="twitter:card" content="summary_large_image">
  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/customize.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://mmf.sh/" aria-label="MMF"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://mmf.sh/docs">Get Started</a>
          </li>


          <li>
            <a href="https://mmf.sh/docs">Docs</a>
          </li>

          <li class="active">
            <a href="https://mmf.sh/api">API</a>
          </li>

          <li>
            <a href="https://github.com/facebookresearch/mmf">Github</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>

  </div>
</div>


<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            

            
              
              
                <div class="version">
                  1.0.0
                </div>
              
            

            


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

            
          </div>

          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Library Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../lib/common/registry.html">common.registry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../lib/common/sample.html">common.sample</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../lib/models/base_model.html">models.base_model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../lib/modules/losses.html">modules.losses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../lib/modules/metrics.html">modules.metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../lib/datasets/base_dataset_builder.html">datasets.base_dataset_builder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../lib/datasets/base_dataset.html">datasets.base_dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../lib/datasets/processors.html">datasets.processors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../lib/utils/text.html">utils.text</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../../../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
          <li><a href="../../index.html">Module code</a> &gt;</li>
        
      <li>mmf.modules.metrics</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>Source code for mmf.modules.metrics</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) Facebook, Inc. and its affiliates.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The metrics module contains implementations of various metrics used commonly to</span>
<span class="sd">understand how well our models are performing. For e.g. accuracy, vqa_accuracy,</span>
<span class="sd">r@1 etc.</span>

<span class="sd">For implementing your own metric, you need to follow these steps:</span>

<span class="sd">1. Create your own metric class and inherit ``BaseMetric`` class.</span>
<span class="sd">2. In the ``__init__`` function of your class, make sure to call</span>
<span class="sd">   ``super().__init__(&#39;name&#39;)`` where &#39;name&#39; is the name of your metric. If</span>
<span class="sd">   you require any parameters in your ``__init__`` function, you can use</span>
<span class="sd">   keyword arguments to represent them and metric constructor will take care of</span>
<span class="sd">   providing them to your class from config.</span>
<span class="sd">3. Implement a ``calculate`` function which takes in ``SampleList`` and</span>
<span class="sd">   `model_output` as input and return back a float tensor/number.</span>
<span class="sd">4. Register your metric with a key &#39;name&#39; by using decorator,</span>
<span class="sd">   ``@registry.register_metric(&#39;name&#39;)``.</span>

<span class="sd">Example::</span>

<span class="sd">    import torch</span>

<span class="sd">    from mmf.common.registry import registry</span>
<span class="sd">    from mmf.modules.metrics import BaseMetric</span>

<span class="sd">    @registry.register_metric(&quot;some&quot;)</span>
<span class="sd">    class SomeMetric(BaseMetric):</span>
<span class="sd">        def __init__(self, some_param=None):</span>
<span class="sd">            super().__init__(&quot;some&quot;)</span>
<span class="sd">            ....</span>

<span class="sd">        def calculate(self, sample_list, model_output):</span>
<span class="sd">            metric = torch.tensor(2, dtype=torch.float)</span>
<span class="sd">            return metric</span>

<span class="sd">Example config for above metric::</span>

<span class="sd">    model_config:</span>
<span class="sd">        pythia:</span>
<span class="sd">            metrics:</span>
<span class="sd">            - type: some</span>
<span class="sd">              params:</span>
<span class="sd">                some_param: a</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">mmf.common.registry</span> <span class="kn">import</span> <span class="n">registry</span>
<span class="kn">from</span> <span class="nn">mmf.datasets.processors.processors</span> <span class="kn">import</span> <span class="n">EvalAIAnswerProcessor</span>
<span class="kn">from</span> <span class="nn">mmf.utils.logger</span> <span class="kn">import</span> <span class="n">log_class_usage</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">average_precision_score</span><span class="p">,</span>
    <span class="n">f1_score</span><span class="p">,</span>
    <span class="n">precision_recall_curve</span><span class="p">,</span>
    <span class="n">roc_auc_score</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">Tensor</span>


<span class="k">def</span> <span class="nf">_convert_to_one_hot</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
    <span class="c1"># This won&#39;t get called in case of multilabel, only multiclass or binary</span>
    <span class="c1"># as multilabel will anyways be multi hot vector</span>
    <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">!=</span> <span class="n">expected</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="ow">and</span> <span class="n">expected</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span>
            <span class="n">expected</span><span class="o">.</span><span class="n">long</span><span class="p">(),</span> <span class="n">num_classes</span><span class="o">=</span><span class="n">output</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">expected</span>


<div class="viewcode-block" id="Metrics"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.Metrics">[docs]</a><span class="k">class</span> <span class="nc">Metrics</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Internally used by MMF, Metrics acts as wrapper for handling</span>
<span class="sd">    calculation of metrics over various metrics specified by the model in</span>
<span class="sd">    the config. It initializes all of the metrics and when called it runs</span>
<span class="sd">    calculate on each of them one by one and returns back a dict with proper</span>
<span class="sd">    naming back. For e.g. an example dict returned by Metrics class:</span>
<span class="sd">    ``{&#39;val/vqa_accuracy&#39;: 0.3, &#39;val/r@1&#39;: 0.8}``</span>

<span class="sd">    Args:</span>
<span class="sd">        metric_list (ListConfig): List of DictConfigs where each DictConfig</span>
<span class="sd">                                        specifies name and parameters of the</span>
<span class="sd">                                        metrics used.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metric_list</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">):</span>
            <span class="n">metric_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">metric_list</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_metrics</span><span class="p">(</span><span class="n">metric_list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric_list</span><span class="p">):</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">required_params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;dataset_name&quot;</span><span class="p">,</span> <span class="s2">&quot;dataset_type&quot;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metric_list</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">dataset_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">&quot;type&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Metric </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> needs to have &#39;type&#39; attribute &quot;</span>
                        <span class="o">+</span> <span class="s2">&quot;or should be a string&quot;</span>
                    <span class="p">)</span>
                <span class="n">metric_type</span> <span class="o">=</span> <span class="n">key</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">type</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;params&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="c1"># Support cases where uses need to give custom metric name</span>
                <span class="k">if</span> <span class="s2">&quot;key&quot;</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">key</span>

                <span class="c1"># One key should only be used once</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Metric with type/key &#39;</span><span class="si">{</span><span class="n">metric_type</span><span class="si">}</span><span class="s2">&#39; has been defined more &quot;</span>
                        <span class="o">+</span> <span class="s2">&quot;than once in metric list.&quot;</span>
                    <span class="p">)</span>

                <span class="c1"># a custom list of dataset where this metric will be applied</span>
                <span class="k">if</span> <span class="s2">&quot;datasets&quot;</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">:</span>
                    <span class="n">dataset_names</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">datasets</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="s2">&quot;Metric </span><span class="si">{}</span><span class="s2"> has inappropriate type&quot;</span>
                        <span class="s2">&quot;&#39;dict&#39; or &#39;str&#39; allowed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">metric_type</span> <span class="o">=</span> <span class="n">key</span> <span class="o">=</span> <span class="n">metric</span>

            <span class="n">metric_cls</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="n">get_metric_class</span><span class="p">(</span><span class="n">metric_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">metric_cls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No metric named </span><span class="si">{</span><span class="n">metric_type</span><span class="si">}</span><span class="s2"> registered to registry&quot;</span>
                <span class="p">)</span>

            <span class="n">metric_instance</span> <span class="o">=</span> <span class="n">metric_cls</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
            <span class="n">metric_instance</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">key</span>
            <span class="n">metric_instance</span><span class="o">.</span><span class="n">set_applicable_datasets</span><span class="p">(</span><span class="n">dataset_names</span><span class="p">)</span>

            <span class="n">metrics</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_instance</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">required_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">required_params</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">metrics</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">dataset_type</span> <span class="o">=</span> <span class="n">sample_list</span><span class="o">.</span><span class="n">dataset_type</span>
        <span class="n">dataset_name</span> <span class="o">=</span> <span class="n">sample_list</span><span class="o">.</span><span class="n">dataset_name</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_object</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_object</span><span class="o">.</span><span class="n">is_dataset_applicable</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dataset_type</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">values</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_object</span><span class="o">.</span><span class="n">_calculate_with_checks</span><span class="p">(</span>
                    <span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                    <span class="n">values</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">values</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">values</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">values</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">registry</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;metrics&quot;</span><span class="p">,</span> <span class="n">sample_list</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">,</span> <span class="n">dataset_type</span><span class="p">),</span> <span class="n">values</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">values</span></div>


<div class="viewcode-block" id="BaseMetric"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.BaseMetric">[docs]</a><span class="k">class</span> <span class="nc">BaseMetric</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Base class to be inherited by all metrics registered to MMF. See</span>
<span class="sd">    the description on top of the file for more information. Child class must</span>
<span class="sd">    implement ``calculate`` function.</span>

<span class="sd">    Args:</span>
<span class="sd">        name (str): Name of the metric.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">required_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">,</span> <span class="s2">&quot;targets&quot;</span><span class="p">]</span>
        <span class="c1"># the set of datasets where this metric will be applied</span>
        <span class="c1"># an empty set means it will be applied on *all* datasets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">log_class_usage</span><span class="p">(</span><span class="s2">&quot;Metric&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

    <span class="nd">@name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>

<div class="viewcode-block" id="BaseMetric.calculate"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.BaseMetric.calculate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Abstract method to be implemented by the child class. Takes</span>
<span class="sd">        in a ``SampleList`` and a dict returned by model as output and</span>
<span class="sd">        returns back a float tensor/number indicating value for this metric.</span>

<span class="sd">        Args:</span>
<span class="sd">            sample_list (SampleList): SampleList provided by the dataloader for the</span>
<span class="sd">                                current iteration.</span>
<span class="sd">            model_output (Dict): Output dict from the model for the current</span>
<span class="sd">                                 SampleList</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.Tensor|float: Value of the metric.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Override in your child class</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;&#39;calculate&#39; must be implemented in the child class&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_calculate_with_checks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">set_applicable_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_names</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">dataset_names</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_dataset_applicable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dataset_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">dataset_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataset_names</span></div>


<div class="viewcode-block" id="Accuracy"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.Accuracy">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;accuracy&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Accuracy</span><span class="p">(</span><span class="n">BaseMetric</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Metric for calculating accuracy.</span>

<span class="sd">    **Key:** ``accuracy``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">score_key</span><span class="o">=</span><span class="s2">&quot;scores&quot;</span><span class="p">,</span> <span class="n">target_key</span><span class="o">=</span><span class="s2">&quot;targets&quot;</span><span class="p">,</span> <span class="n">topk</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;accuracy&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score_key</span> <span class="o">=</span> <span class="n">score_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_key</span> <span class="o">=</span> <span class="n">target_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topk</span> <span class="o">=</span> <span class="n">topk</span>

<div class="viewcode-block" id="Accuracy.calculate"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.Accuracy.calculate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate accuracy and return it back.</span>

<span class="sd">        Args:</span>
<span class="sd">            sample_list (SampleList): SampleList provided by DataLoader for</span>
<span class="sd">                                current iteration</span>
<span class="sd">            model_output (Dict): Dict returned by model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.FloatTensor: accuracy.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model_output</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">score_key</span><span class="p">]</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">sample_list</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">target_key</span><span class="p">]</span>

        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">output</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">2</span>
        <span class="p">),</span> <span class="s2">&quot;Output from model shouldn&#39;t have more than dim 2 for accuracy&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">expected</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">2</span>
        <span class="p">),</span> <span class="s2">&quot;Expected target shouldn&#39;t have more than dim 2 for accuracy&quot;</span>

        <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topk</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

        <span class="c1"># If more than 1</span>
        <span class="c1"># If last dim is 1, we directly have class indices</span>
        <span class="k">if</span> <span class="n">expected</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">expected</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="n">expected</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topk</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

        <span class="n">correct</span> <span class="o">=</span> <span class="p">(</span><span class="n">expected</span> <span class="o">==</span> <span class="n">output</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">correct</span> <span class="o">/</span> <span class="n">batch_size</span></div></div>


<div class="viewcode-block" id="TopKAccuracy"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.TopKAccuracy">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;topk_accuracy&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TopKAccuracy</span><span class="p">(</span><span class="n">Accuracy</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">score_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">score_key</span><span class="o">=</span><span class="n">score_key</span><span class="p">,</span> <span class="n">topk</span><span class="o">=</span><span class="n">k</span><span class="p">)</span></div>


<div class="viewcode-block" id="CaptionBleu4Metric"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.CaptionBleu4Metric">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;caption_bleu4&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">CaptionBleu4Metric</span><span class="p">(</span><span class="n">BaseMetric</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Metric for calculating caption accuracy using BLEU4 Score.</span>

<span class="sd">    **Key:** ``caption_bleu4``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">nltk.translate.bleu_score</span> <span class="k">as</span> <span class="nn">bleu_score</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_bleu_score</span> <span class="o">=</span> <span class="n">bleu_score</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;caption_bleu4&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caption_processor</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;coco_caption_processor&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">required_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">,</span> <span class="s2">&quot;answers&quot;</span><span class="p">,</span> <span class="s2">&quot;captions&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="CaptionBleu4Metric.calculate"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.CaptionBleu4Metric.calculate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate accuracy and return it back.</span>

<span class="sd">        Args:</span>
<span class="sd">            sample_list (SampleList): SampleList provided by DataLoader for</span>
<span class="sd">                                current iteration</span>
<span class="sd">            model_output (Dict): Dict returned by model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.FloatTensor: bleu4 score.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create reference and hypotheses captions.</span>
        <span class="n">references</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">hypotheses</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># References</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">sample_list</span><span class="o">.</span><span class="n">answers</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">targets</span><span class="p">):</span>
            <span class="n">img_captions</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">caption_processor</span><span class="p">(</span><span class="n">c</span><span class="p">)[</span><span class="s2">&quot;tokens&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="p">]</span>
            <span class="n">references</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img_captions</span><span class="p">)</span>

        <span class="c1"># Hypotheses</span>
        <span class="k">if</span> <span class="s2">&quot;captions&quot;</span> <span class="ow">in</span> <span class="n">model_output</span><span class="p">:</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="n">model_output</span><span class="p">[</span><span class="s2">&quot;captions&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">model_output</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scores</span><span class="p">):</span>
            <span class="n">caption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caption_processor</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">j</span><span class="p">])[</span><span class="s2">&quot;tokens&quot;</span><span class="p">]</span>
            <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">caption</span><span class="p">)</span>
        <span class="n">hypotheses</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">references</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">hypotheses</span><span class="p">)</span>

        <span class="n">bleu4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bleu_score</span><span class="o">.</span><span class="n">corpus_bleu</span><span class="p">(</span><span class="n">references</span><span class="p">,</span> <span class="n">hypotheses</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">targets</span><span class="o">.</span><span class="n">new_tensor</span><span class="p">(</span><span class="n">bleu4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="VQAAccuracy"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.VQAAccuracy">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;vqa_accuracy&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">VQAAccuracy</span><span class="p">(</span><span class="n">BaseMetric</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate VQAAccuracy. Find more information here_</span>

<span class="sd">    **Key**: ``vqa_accuracy``.</span>

<span class="sd">    .. _here: https://visualqa.org/evaluation.html</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;vqa_accuracy&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_masked_unk_softmax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">mask_idx</span><span class="p">):</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">)</span>
        <span class="n">x1</span><span class="p">[:,</span> <span class="n">mask_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">x1_sum</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">/</span> <span class="n">x1_sum</span>
        <span class="k">return</span> <span class="n">y</span>

<div class="viewcode-block" id="VQAAccuracy.calculate"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.VQAAccuracy.calculate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate vqa accuracy and return it back.</span>

<span class="sd">        Args:</span>
<span class="sd">            sample_list (SampleList): SampleList provided by DataLoader for</span>
<span class="sd">                                current iteration</span>
<span class="sd">            model_output (Dict): Dict returned by model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.FloatTensor: VQA Accuracy</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model_output</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span>
        <span class="c1"># for three branch movie+mcan model</span>
        <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">sample_list</span><span class="p">[</span><span class="s2">&quot;targets&quot;</span><span class="p">]</span>

        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_masked_unk_softmax</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># argmax</span>

        <span class="n">one_hots</span> <span class="o">=</span> <span class="n">expected</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">(</span><span class="o">*</span><span class="n">expected</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
        <span class="n">one_hots</span><span class="o">.</span><span class="n">scatter_</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">output</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">one_hots</span> <span class="o">*</span> <span class="n">expected</span>
        <span class="n">accuracy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="o">/</span> <span class="n">expected</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">accuracy</span></div></div>


<div class="viewcode-block" id="VQAEvalAIAccuracy"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.VQAEvalAIAccuracy">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;vqa_evalai_accuracy&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">VQAEvalAIAccuracy</span><span class="p">(</span><span class="n">BaseMetric</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate Eval AI VQAAccuracy. Find more information here_</span>
<span class="sd">    This is more accurate and similar comparision to Eval AI</span>
<span class="sd">    but is slower compared to vqa_accuracy.</span>

<span class="sd">    **Key**: ``vqa_evalai_accuracy``.</span>

<span class="sd">    .. _here: https://visualqa.org/evaluation.html</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;vqa_evalai_accuracy&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evalai_answer_processor</span> <span class="o">=</span> <span class="n">EvalAIAnswerProcessor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">required_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">,</span> <span class="s2">&quot;answers&quot;</span><span class="p">,</span> <span class="s2">&quot;context_tokens&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_masked_unk_softmax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">mask_idx</span><span class="p">):</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">)</span>
        <span class="n">x1</span><span class="p">[:,</span> <span class="n">mask_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">x1_sum</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">/</span> <span class="n">x1_sum</span>
        <span class="k">return</span> <span class="n">y</span>

<div class="viewcode-block" id="VQAEvalAIAccuracy.calculate"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.VQAEvalAIAccuracy.calculate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate vqa accuracy and return it back.</span>

<span class="sd">        Args:</span>
<span class="sd">            sample_list (SampleList): SampleList provided by DataLoader for</span>
<span class="sd">                                current iteration</span>
<span class="sd">            model_output (Dict): Dict returned by model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.FloatTensor: VQA Accuracy</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model_output</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">sample_list</span><span class="p">[</span><span class="s2">&quot;answers&quot;</span><span class="p">]</span>

        <span class="n">answer_processor</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sample_list</span><span class="o">.</span><span class="n">dataset_name</span> <span class="o">+</span> <span class="s2">&quot;_answer_processor&quot;</span><span class="p">)</span>
        <span class="n">answer_space_size</span> <span class="o">=</span> <span class="n">answer_processor</span><span class="o">.</span><span class="n">get_true_vocab_size</span><span class="p">()</span>

        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_masked_unk_softmax</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">accuracy</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">answer_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">answer_id</span> <span class="o">&gt;=</span> <span class="n">answer_space_size</span><span class="p">:</span>
                <span class="n">answer_id</span> <span class="o">-=</span> <span class="n">answer_space_size</span>
                <span class="n">answer</span> <span class="o">=</span> <span class="n">sample_list</span><span class="p">[</span><span class="s2">&quot;context_tokens&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">][</span><span class="n">answer_id</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">answer</span> <span class="o">=</span> <span class="n">answer_processor</span><span class="o">.</span><span class="n">idx2word</span><span class="p">(</span><span class="n">answer_id</span><span class="p">)</span>

            <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evalai_answer_processor</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>

            <span class="n">gt_answers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">evalai_answer_processor</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">expected</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span>
            <span class="n">gt_answers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">gt_answers</span><span class="p">))</span>

            <span class="n">gt_acc</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">gt_answer</span> <span class="ow">in</span> <span class="n">gt_answers</span><span class="p">:</span>
                <span class="n">other_answers</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">gt_answers</span> <span class="k">if</span> <span class="n">item</span> <span class="o">!=</span> <span class="n">gt_answer</span><span class="p">]</span>
                <span class="n">matching_answers</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">other_answers</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">answer</span><span class="p">]</span>
                <span class="n">acc</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matching_answers</span><span class="p">))</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
                <span class="n">gt_acc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>
            <span class="n">avgGTAcc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">gt_acc</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">gt_acc</span><span class="p">)</span>
            <span class="n">accuracy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avgGTAcc</span><span class="p">)</span>

        <span class="n">accuracy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">accuracy</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">accuracy</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">model_output</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">new_tensor</span><span class="p">(</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="RecallAtK"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.RecallAtK">[docs]</a><span class="k">class</span> <span class="nc">RecallAtK</span><span class="p">(</span><span class="n">BaseMetric</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;recall@k&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">score_to_ranks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scores</span><span class="p">):</span>
        <span class="c1"># sort in descending order - largest score gets highest rank</span>
        <span class="n">sorted_ranks</span><span class="p">,</span> <span class="n">ranked_idx</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># convert from ranked_idx to ranks</span>
        <span class="n">ranks</span> <span class="o">=</span> <span class="n">ranked_idx</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ranked_idx</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
                <span class="n">ranks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ranked_idx</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="n">j</span>
        <span class="n">ranks</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">ranks</span>

    <span class="k">def</span> <span class="nf">get_gt_ranks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranks</span><span class="p">,</span> <span class="n">ans_ind</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ans_ind</span> <span class="o">=</span> <span class="n">ans_ind</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ans_ind</span> <span class="o">=</span> <span class="n">ans_ind</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">gt_ranks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">ans_ind</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ans_ind</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
            <span class="n">gt_ranks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ranks</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ans_ind</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">long</span><span class="p">()])</span>
        <span class="k">return</span> <span class="n">gt_ranks</span>

    <span class="k">def</span> <span class="nf">process_ranks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ranks</span><span class="p">):</span>
        <span class="n">num_opts</span> <span class="o">=</span> <span class="mi">100</span>

        <span class="c1"># none of the values should be 0, there is gt in options</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ranks</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">num_zero</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ranks</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Some of ranks are zero: </span><span class="si">{</span><span class="n">num_zero</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ranks</span> <span class="o">=</span> <span class="n">ranks</span><span class="p">[</span><span class="n">ranks</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span>

        <span class="c1"># rank should not exceed the number of options</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ranks</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="n">num_opts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">num_ge</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ranks</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="n">num_opts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Some of ranks &gt; 100: </span><span class="si">{</span><span class="n">num_ge</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ranks</span> <span class="o">=</span> <span class="n">ranks</span><span class="p">[</span><span class="n">ranks</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="n">num_opts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">ranks</span>

    <span class="k">def</span> <span class="nf">get_ranks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model_output</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">sample_list</span><span class="p">[</span><span class="s2">&quot;targets&quot;</span><span class="p">]</span>

        <span class="n">ranks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_to_ranks</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">gt_ranks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_gt_ranks</span><span class="p">(</span><span class="n">ranks</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>

        <span class="n">ranks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_ranks</span><span class="p">(</span><span class="n">gt_ranks</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ranks</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

<div class="viewcode-block" id="RecallAtK.calculate"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.RecallAtK.calculate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">ranks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ranks</span><span class="p">(</span><span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">)</span>
        <span class="n">recall</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="n">ranks</span><span class="p">,</span> <span class="n">k</span><span class="p">)))</span> <span class="o">/</span> <span class="n">ranks</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">recall</span></div></div>


<div class="viewcode-block" id="RecallAt1"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.RecallAt1">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;r@1&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RecallAt1</span><span class="p">(</span><span class="n">RecallAtK</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate Recall@1 which specifies how many time the chosen candidate</span>
<span class="sd">    was rank 1.</span>

<span class="sd">    **Key**: ``r@1``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;r@1&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="RecallAt1.calculate"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.RecallAt1.calculate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate Recall@1 and return it back.</span>

<span class="sd">        Args:</span>
<span class="sd">            sample_list (SampleList): SampleList provided by DataLoader for</span>
<span class="sd">                                current iteration</span>
<span class="sd">            model_output (Dict): Dict returned by model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.FloatTensor: Recall@1</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="RecallAt5"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.RecallAt5">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;r@5&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RecallAt5</span><span class="p">(</span><span class="n">RecallAtK</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate Recall@5 which specifies how many time the chosen candidate</span>
<span class="sd">    was among first 5 rank.</span>

<span class="sd">    **Key**: ``r@5``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;r@5&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="RecallAt5.calculate"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.RecallAt5.calculate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate Recall@5 and return it back.</span>

<span class="sd">        Args:</span>
<span class="sd">            sample_list (SampleList): SampleList provided by DataLoader for</span>
<span class="sd">                                current iteration</span>
<span class="sd">            model_output (Dict): Dict returned by model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.FloatTensor: Recall@5</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="RecallAt10"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.RecallAt10">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;r@10&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RecallAt10</span><span class="p">(</span><span class="n">RecallAtK</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate Recall@10 which specifies how many time the chosen candidate</span>
<span class="sd">    was among first 10 ranks.</span>

<span class="sd">    **Key**: ``r@10``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;r@10&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="RecallAt10.calculate"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.RecallAt10.calculate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate Recall@10 and return it back.</span>

<span class="sd">        Args:</span>
<span class="sd">            sample_list (SampleList): SampleList provided by DataLoader for</span>
<span class="sd">                                current iteration</span>
<span class="sd">            model_output (Dict): Dict returned by model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.FloatTensor: Recall@10</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MeanRank"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.MeanRank">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;mean_r&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MeanRank</span><span class="p">(</span><span class="n">RecallAtK</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate MeanRank which specifies what was the average rank of the chosen</span>
<span class="sd">    candidate.</span>

<span class="sd">    **Key**: ``mean_r``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;mean_r&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="MeanRank.calculate"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.MeanRank.calculate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate Mean Rank and return it back.</span>

<span class="sd">        Args:</span>
<span class="sd">            sample_list (SampleList): SampleList provided by DataLoader for</span>
<span class="sd">                                current iteration</span>
<span class="sd">            model_output (Dict): Dict returned by model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.FloatTensor: mean rank</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ranks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ranks</span><span class="p">(</span><span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ranks</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MeanReciprocalRank"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.MeanReciprocalRank">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;mean_rr&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MeanReciprocalRank</span><span class="p">(</span><span class="n">RecallAtK</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate reciprocal of mean rank..</span>

<span class="sd">    **Key**: ``mean_rr``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;mean_rr&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="MeanReciprocalRank.calculate"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.MeanReciprocalRank.calculate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate Mean Reciprocal Rank and return it back.</span>

<span class="sd">        Args:</span>
<span class="sd">            sample_list (SampleList): SampleList provided by DataLoader for</span>
<span class="sd">                                current iteration</span>
<span class="sd">            model_output (Dict): Dict returned by model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.FloatTensor: Mean Reciprocal Rank</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ranks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ranks</span><span class="p">(</span><span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ranks</span><span class="o">.</span><span class="n">reciprocal</span><span class="p">())</span></div></div>


<div class="viewcode-block" id="TextVQAAccuracy"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.TextVQAAccuracy">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;textvqa_accuracy&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TextVQAAccuracy</span><span class="p">(</span><span class="n">BaseMetric</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;textvqa_accuracy&quot;</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">mmf.utils.m4c_evaluators</span> <span class="k">as</span> <span class="nn">evaluators</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span> <span class="o">=</span> <span class="n">evaluators</span><span class="o">.</span><span class="n">TextVQAAccuracyEvaluator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">required_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">,</span> <span class="s2">&quot;answers&quot;</span><span class="p">,</span> <span class="s2">&quot;context_tokens&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gt_key</span> <span class="o">=</span> <span class="s2">&quot;answers&quot;</span>

<div class="viewcode-block" id="TextVQAAccuracy.calculate"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.TextVQAAccuracy.calculate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">answer_processor</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sample_list</span><span class="o">.</span><span class="n">dataset_name</span> <span class="o">+</span> <span class="s2">&quot;_answer_processor&quot;</span><span class="p">)</span>

        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">sample_list</span><span class="o">.</span><span class="n">context_tokens</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pred_answers</span> <span class="o">=</span> <span class="n">model_output</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">context_tokens</span> <span class="o">=</span> <span class="n">sample_list</span><span class="o">.</span><span class="n">context_tokens</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">answers</span> <span class="o">=</span> <span class="n">sample_list</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gt_key</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">answer_space_size</span> <span class="o">=</span> <span class="n">answer_processor</span><span class="o">.</span><span class="n">get_true_vocab_size</span><span class="p">()</span>

        <span class="n">predictions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="kn">from</span> <span class="nn">mmf.utils.distributed</span> <span class="kn">import</span> <span class="n">byte_tensor_to_object</span>
        <span class="kn">from</span> <span class="nn">mmf.utils.text</span> <span class="kn">import</span> <span class="n">word_tokenize</span>

        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="n">byte_tensor_to_object</span><span class="p">(</span><span class="n">context_tokens</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            <span class="n">answer_words</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">answer_id</span> <span class="ow">in</span> <span class="n">pred_answers</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">answer_id</span> <span class="o">&gt;=</span> <span class="n">answer_space_size</span><span class="p">:</span>
                    <span class="n">answer_id</span> <span class="o">-=</span> <span class="n">answer_space_size</span>
                    <span class="n">answer_words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word_tokenize</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="n">answer_id</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">answer_id</span> <span class="o">==</span> <span class="n">answer_processor</span><span class="o">.</span><span class="n">EOS_IDX</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">answer_words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">answer_processor</span><span class="o">.</span><span class="n">answer_vocab</span><span class="o">.</span><span class="n">idx2word</span><span class="p">(</span><span class="n">answer_id</span><span class="p">)</span>
                    <span class="p">)</span>

            <span class="n">pred_answer</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">answer_words</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &#39;s&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;s&quot;</span><span class="p">)</span>
            <span class="n">gt_answers</span> <span class="o">=</span> <span class="n">byte_tensor_to_object</span><span class="p">(</span><span class="n">answers</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            <span class="n">predictions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;pred_answer&quot;</span><span class="p">:</span> <span class="n">pred_answer</span><span class="p">,</span> <span class="s2">&quot;gt_answers&quot;</span><span class="p">:</span> <span class="n">gt_answers</span><span class="p">})</span>

        <span class="n">accuracy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span><span class="o">.</span><span class="n">eval_pred_list</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
        <span class="n">accuracy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">accuracy</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">sample_list</span><span class="o">.</span><span class="n">context_tokens</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">accuracy</span></div></div>


<div class="viewcode-block" id="STVQAANLS"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.STVQAANLS">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;stvqa_anls&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">STVQAANLS</span><span class="p">(</span><span class="n">TextVQAAccuracy</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;stvqa_anls&quot;</span>
        <span class="kn">import</span> <span class="nn">mmf.utils.m4c_evaluators</span> <span class="k">as</span> <span class="nn">evaluators</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span> <span class="o">=</span> <span class="n">evaluators</span><span class="o">.</span><span class="n">STVQAANLSEvaluator</span><span class="p">()</span></div>


<div class="viewcode-block" id="STVQAAccuracy"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.STVQAAccuracy">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;stvqa_accuracy&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">STVQAAccuracy</span><span class="p">(</span><span class="n">TextVQAAccuracy</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;stvqa_accuracy&quot;</span>
        <span class="kn">import</span> <span class="nn">mmf.utils.m4c_evaluators</span> <span class="k">as</span> <span class="nn">evaluators</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span> <span class="o">=</span> <span class="n">evaluators</span><span class="o">.</span><span class="n">STVQAAccuracyEvaluator</span><span class="p">()</span></div>


<div class="viewcode-block" id="OCRVQAAccuracy"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.OCRVQAAccuracy">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;ocrvqa_accuracy&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">OCRVQAAccuracy</span><span class="p">(</span><span class="n">STVQAAccuracy</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># same as STVQAAccuracy except for the name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;ocrvqa_accuracy&quot;</span></div>


<div class="viewcode-block" id="TextCapsBleu4"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.TextCapsBleu4">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;textcaps_bleu4&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TextCapsBleu4</span><span class="p">(</span><span class="n">TextVQAAccuracy</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;textcaps_bleu4&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">required_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">,</span> <span class="s2">&quot;ref_strs&quot;</span><span class="p">,</span> <span class="s2">&quot;context_tokens&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gt_key</span> <span class="o">=</span> <span class="s2">&quot;ref_strs&quot;</span>
        <span class="kn">import</span> <span class="nn">mmf.utils.m4c_evaluators</span> <span class="k">as</span> <span class="nn">evaluators</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">evaluator</span> <span class="o">=</span> <span class="n">evaluators</span><span class="o">.</span><span class="n">TextCapsBleu4Evaluator</span><span class="p">()</span></div>


<div class="viewcode-block" id="F1"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.F1">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;f1&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">F1</span><span class="p">(</span><span class="n">BaseMetric</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Metric for calculating F1. Can be used with type and params</span>
<span class="sd">    argument for customization. params will be directly passed to sklearn</span>
<span class="sd">    f1 function.</span>
<span class="sd">    **Key:** ``f1``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;f1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_multilabel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;multilabel&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sk_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

<div class="viewcode-block" id="F1.calculate"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.F1.calculate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate f1 and return it back.</span>

<span class="sd">        Args:</span>
<span class="sd">            sample_list (SampleList): SampleList provided by DataLoader for</span>
<span class="sd">                                current iteration</span>
<span class="sd">            model_output (Dict): Dict returned by model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.FloatTensor: f1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">model_output</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">sample_list</span><span class="p">[</span><span class="s2">&quot;targets&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_multilabel</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="n">_convert_to_one_hot</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Multiclass, or binary case</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">expected</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Probably one-hot, convert back to class indices array</span>
                <span class="n">expected</span> <span class="o">=</span> <span class="n">expected</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">expected</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">output</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_sk_kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">expected</span><span class="o">.</span><span class="n">new_tensor</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MacroF1"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.MacroF1">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;macro_f1&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MacroF1</span><span class="p">(</span><span class="n">F1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Metric for calculating Macro F1.</span>

<span class="sd">    **Key:** ``macro_f1``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">average</span><span class="o">=</span><span class="s2">&quot;macro&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;macro_f1&quot;</span></div>


<div class="viewcode-block" id="MicroF1"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.MicroF1">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;micro_f1&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MicroF1</span><span class="p">(</span><span class="n">F1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Metric for calculating Micro F1.</span>

<span class="sd">    **Key:** ``micro_f1``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">average</span><span class="o">=</span><span class="s2">&quot;micro&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;micro_f1&quot;</span></div>


<div class="viewcode-block" id="BinaryF1"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.BinaryF1">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;binary_f1&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">BinaryF1</span><span class="p">(</span><span class="n">F1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Metric for calculating Binary F1.</span>

<span class="sd">    **Key:** ``binary_f1``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">average</span><span class="o">=</span><span class="s2">&quot;micro&quot;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;binary_f1&quot;</span></div>


<div class="viewcode-block" id="MultiLabelF1"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.MultiLabelF1">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;multilabel_f1&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MultiLabelF1</span><span class="p">(</span><span class="n">F1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Metric for calculating Multilabel F1.</span>

<span class="sd">    **Key:** ``multilabel_f1``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">multilabel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;multilabel_f1&quot;</span></div>


<div class="viewcode-block" id="MultiLabelMicroF1"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.MultiLabelMicroF1">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;multilabel_micro_f1&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MultiLabelMicroF1</span><span class="p">(</span><span class="n">MultiLabelF1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Metric for calculating Multilabel Micro F1.</span>

<span class="sd">    **Key:** ``multilabel_micro_f1``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">average</span><span class="o">=</span><span class="s2">&quot;micro&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;multilabel_micro_f1&quot;</span></div>


<div class="viewcode-block" id="MultiLabelMacroF1"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.MultiLabelMacroF1">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;multilabel_macro_f1&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MultiLabelMacroF1</span><span class="p">(</span><span class="n">MultiLabelF1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Metric for calculating Multilabel Macro F1.</span>

<span class="sd">    **Key:** ``multilabel_macro_f1``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">average</span><span class="o">=</span><span class="s2">&quot;macro&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;multilabel_macro_f1&quot;</span></div>


<div class="viewcode-block" id="ROC_AUC"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.ROC_AUC">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;roc_auc&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ROC_AUC</span><span class="p">(</span><span class="n">BaseMetric</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Metric for calculating ROC_AUC.</span>
<span class="sd">    See more details at `sklearn.metrics.roc_auc_score &lt;http://scikit-learn.org/stable/modules/generated/sklearn.metrics.roc_auc_score.html#sklearn.metrics.roc_auc_score&gt;`_ # noqa</span>

<span class="sd">    **Note**: ROC_AUC is not defined when expected tensor only contains one</span>
<span class="sd">    label. Make sure you have both labels always or use it on full val only</span>

<span class="sd">    **Key:** ``roc_auc``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;roc_auc&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sk_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

<div class="viewcode-block" id="ROC_AUC.calculate"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.ROC_AUC.calculate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate ROC_AUC and returns it back. The function performs softmax</span>
<span class="sd">        on the logits provided and then calculated the ROC_AUC.</span>

<span class="sd">        Args:</span>
<span class="sd">            sample_list (SampleList): SampleList provided by DataLoader for</span>
<span class="sd">                                current iteration.</span>
<span class="sd">            model_output (Dict): Dict returned by model. This should contain &quot;scores&quot;</span>
<span class="sd">                                 field pointing to logits returned from the model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.FloatTensor: ROC_AUC.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">model_output</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">sample_list</span><span class="p">[</span><span class="s2">&quot;targets&quot;</span><span class="p">]</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">_convert_to_one_hot</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">expected</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">output</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_sk_kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">expected</span><span class="o">.</span><span class="n">new_tensor</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MicroROC_AUC"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.MicroROC_AUC">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;micro_roc_auc&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MicroROC_AUC</span><span class="p">(</span><span class="n">ROC_AUC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Metric for calculating Micro ROC_AUC.</span>

<span class="sd">    **Key:** ``micro_roc_auc``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">average</span><span class="o">=</span><span class="s2">&quot;micro&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;micro_roc_auc&quot;</span></div>


<div class="viewcode-block" id="MacroROC_AUC"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.MacroROC_AUC">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;macro_roc_auc&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MacroROC_AUC</span><span class="p">(</span><span class="n">ROC_AUC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Metric for calculating Macro ROC_AUC.</span>

<span class="sd">    **Key:** ``macro_roc_auc``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">average</span><span class="o">=</span><span class="s2">&quot;macro&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;macro_roc_auc&quot;</span></div>


<div class="viewcode-block" id="AveragePrecision"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.AveragePrecision">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;ap&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">AveragePrecision</span><span class="p">(</span><span class="n">BaseMetric</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Metric for calculating Average Precision.</span>
<span class="sd">    See more details at `sklearn.metrics.average_precision_score &lt;http://scikit-learn.org/stable/modules/generated/sklearn.metrics.average_precision_score.html#sklearn.metrics.average_precision_score&gt;`_ # noqa</span>
<span class="sd">    If you are looking for binary case, please take a look at binary_ap</span>
<span class="sd">    **Key:** ``ap``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;ap&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sk_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

<div class="viewcode-block" id="AveragePrecision.calculate"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.AveragePrecision.calculate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate AP and returns it back. The function performs softmax</span>
<span class="sd">        on the logits provided and then calculated the AP.</span>

<span class="sd">        Args:</span>
<span class="sd">            sample_list (SampleList): SampleList provided by DataLoader for</span>
<span class="sd">                                current iteration.</span>
<span class="sd">            model_output (Dict): Dict returned by model. This should contain &quot;scores&quot;</span>
<span class="sd">                                 field pointing to logits returned from the model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.FloatTensor: AP.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">model_output</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">sample_list</span><span class="p">[</span><span class="s2">&quot;targets&quot;</span><span class="p">]</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">_convert_to_one_hot</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">average_precision_score</span><span class="p">(</span><span class="n">expected</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">output</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_sk_kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">expected</span><span class="o">.</span><span class="n">new_tensor</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BinaryAP"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.BinaryAP">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;binary_ap&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">BinaryAP</span><span class="p">(</span><span class="n">AveragePrecision</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Metric for calculating Binary Average Precision.</span>
<span class="sd">    See more details at `sklearn.metrics.average_precision_score &lt;http://scikit-learn.org/stable/modules/generated/sklearn.metrics.average_precision_score.html#sklearn.metrics.average_precision_score&gt;`_ # noqa</span>
<span class="sd">    **Key:** ``binary_ap``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;binary_ap&quot;</span>

<div class="viewcode-block" id="BinaryAP.calculate"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.BinaryAP.calculate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate Binary AP and returns it back. The function performs softmax</span>
<span class="sd">        on the logits provided and then calculated the binary AP.</span>

<span class="sd">        Args:</span>
<span class="sd">            sample_list (SampleList): SampleList provided by DataLoader for</span>
<span class="sd">                                current iteration.</span>
<span class="sd">            model_output (Dict): Dict returned by model. This should contain &quot;scores&quot;</span>
<span class="sd">                                 field pointing to logits returned from the model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.FloatTensor: AP.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">model_output</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Take the score for positive (1) label</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">sample_list</span><span class="p">[</span><span class="s2">&quot;targets&quot;</span><span class="p">]</span>

        <span class="c1"># One hot format -&gt; Labels</span>
        <span class="k">if</span> <span class="n">expected</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="n">expected</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">average_precision_score</span><span class="p">(</span><span class="n">expected</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">output</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_sk_kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">expected</span><span class="o">.</span><span class="n">new_tensor</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MicroAP"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.MicroAP">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;micro_ap&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MicroAP</span><span class="p">(</span><span class="n">AveragePrecision</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Metric for calculating Micro Average Precision.</span>

<span class="sd">    **Key:** ``micro_ap``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">average</span><span class="o">=</span><span class="s2">&quot;micro&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;micro_ap&quot;</span></div>


<div class="viewcode-block" id="MacroAP"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.MacroAP">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;macro_ap&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MacroAP</span><span class="p">(</span><span class="n">AveragePrecision</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Metric for calculating Macro Average Precision.</span>

<span class="sd">    **Key:** ``macro_ap``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">average</span><span class="o">=</span><span class="s2">&quot;macro&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;macro_ap&quot;</span></div>


<div class="viewcode-block" id="RecallAtPrecisionK"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.RecallAtPrecisionK">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;r@pk&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RecallAtPrecisionK</span><span class="p">(</span><span class="n">BaseMetric</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Metric for calculating recall when precision is above a</span>
<span class="sd">    particular threshold. Use `p_threshold` param to specify the</span>
<span class="sd">    precision threshold i.e. k. Accepts precision in both 0-1</span>
<span class="sd">    and 1-100 format.</span>

<span class="sd">    **Key:** ``r@pk``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_threshold</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialization function recall @ precision k</span>

<span class="sd">        Args:</span>
<span class="sd">            p_threshold (float): Precision threshold</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;r@pk&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;r@pk&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p_threshold</span> <span class="o">=</span> <span class="n">p_threshold</span> <span class="k">if</span> <span class="n">p_threshold</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">p_threshold</span> <span class="o">/</span> <span class="mi">100</span>

<div class="viewcode-block" id="RecallAtPrecisionK.calculate"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.RecallAtPrecisionK.calculate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate Recall at precision k and returns it back. The function</span>
<span class="sd">        performs softmax on the logits provided and then calculated the metric.</span>

<span class="sd">        Args:</span>
<span class="sd">            sample_list (SampleList): SampleList provided by DataLoader for</span>
<span class="sd">                                current iteration.</span>
<span class="sd">            model_output (Dict): Dict returned by model. This should contain &quot;scores&quot;</span>
<span class="sd">                                 field pointing to logits returned from the model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.FloatTensor: Recall @ precision k.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">model_output</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">sample_list</span><span class="p">[</span><span class="s2">&quot;targets&quot;</span><span class="p">]</span>

        <span class="c1"># One hot format -&gt; Labels</span>
        <span class="k">if</span> <span class="n">expected</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="n">expected</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">thresh</span> <span class="o">=</span> <span class="n">precision_recall_curve</span><span class="p">(</span><span class="n">expected</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">output</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_threshold</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">expected</span><span class="o">.</span><span class="n">new_tensor</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="RecallAtK_ret"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.RecallAtK_ret">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;r@k_retrieval&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RecallAtK_ret</span><span class="p">(</span><span class="n">BaseMetric</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;recall@k&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_RatK_multi</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">correlations</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">labels</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">factor</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">top_k_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">correlations</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">hits</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                <span class="n">labels</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">top_k_ids</span><span class="p">,</span> <span class="n">top_k_ids</span> <span class="o">&lt;</span> <span class="n">labels</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">factor</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">long</span><span class="p">()</span>
            <span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">hits</span>

<div class="viewcode-block" id="RecallAtK_ret.calculate"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.RecallAtK_ret.calculate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sample_list</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
        <span class="n">model_output</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">flip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># calculate image to text retrieval recalls</span>
        <span class="c1"># correlations shape is either BxB or Bx(5B)</span>
        <span class="c1"># when flip=True, calculate text to image</span>
        <span class="n">image_embeddings</span> <span class="o">=</span> <span class="n">model_output</span><span class="p">[</span><span class="s2">&quot;scores&quot;</span><span class="p">]</span>
        <span class="n">text_embeddings</span> <span class="o">=</span> <span class="n">model_output</span><span class="p">[</span><span class="s2">&quot;targets&quot;</span><span class="p">]</span>

        <span class="n">correlations</span> <span class="o">=</span> <span class="n">image_embeddings</span> <span class="o">@</span> <span class="n">text_embeddings</span><span class="o">.</span><span class="n">t</span><span class="p">()</span>  <span class="c1"># B x B or Bx5B</span>
        <span class="k">assert</span> <span class="n">correlations</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="n">correlations</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">correlations</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">correlations</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="n">correlations</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">image_embeddings</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="o">*</span> <span class="n">factor</span>
        <span class="k">if</span> <span class="n">flip</span><span class="p">:</span>
            <span class="n">correlations</span> <span class="o">=</span> <span class="n">correlations</span><span class="o">.</span><span class="n">t</span><span class="p">()</span>  <span class="c1"># 5B x B</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">image_embeddings</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">factor</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">hits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_RatK_multi</span><span class="p">(</span><span class="n">correlations</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">factor</span><span class="p">)</span>
        <span class="n">ratk</span> <span class="o">=</span> <span class="n">hits</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">/</span> <span class="n">hits</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ratk</span></div></div>


<div class="viewcode-block" id="RecallAt1_ret"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.RecallAt1_ret">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;r@1_retrieval&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RecallAt1_ret</span><span class="p">(</span><span class="n">RecallAtK_ret</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;r@1&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="RecallAt1_ret.calculate"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.RecallAt1_ret.calculate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sample_list</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
        <span class="n">model_output</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">ratk</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ratk</span></div></div>


<div class="viewcode-block" id="RecallAt1_rev_ret"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.RecallAt1_rev_ret">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;r@1_rev_retrieval&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RecallAt1_rev_ret</span><span class="p">(</span><span class="n">RecallAtK_ret</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;r@1_rev&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="RecallAt1_rev_ret.calculate"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.RecallAt1_rev_ret.calculate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sample_list</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
        <span class="n">model_output</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">ratk</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">flip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ratk</span></div></div>


<div class="viewcode-block" id="RecallAt5_ret"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.RecallAt5_ret">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;r@5_retrieval&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RecallAt5_ret</span><span class="p">(</span><span class="n">RecallAtK_ret</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;r@5&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="RecallAt5_ret.calculate"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.RecallAt5_ret.calculate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sample_list</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
        <span class="n">model_output</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">ratk</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ratk</span></div></div>


<div class="viewcode-block" id="RecallAt5_rev_ret"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.RecallAt5_rev_ret">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;r@5_rev_retrieval&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RecallAt5_rev_ret</span><span class="p">(</span><span class="n">RecallAtK_ret</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;r@5_rev&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="RecallAt5_rev_ret.calculate"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.RecallAt5_rev_ret.calculate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sample_list</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
        <span class="n">model_output</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">ratk</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">flip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ratk</span></div></div>


<div class="viewcode-block" id="RecallAt10_ret"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.RecallAt10_ret">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;r@10_retrieval&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RecallAt10_ret</span><span class="p">(</span><span class="n">RecallAtK_ret</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;r@10&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="RecallAt10_ret.calculate"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.RecallAt10_ret.calculate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sample_list</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
        <span class="n">model_output</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">ratk</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ratk</span></div></div>


<div class="viewcode-block" id="RecallAt10_rev_ret"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.RecallAt10_rev_ret">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;r@10_rev_retrieval&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RecallAt10_rev_ret</span><span class="p">(</span><span class="n">RecallAtK_ret</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;r@10_rev&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="RecallAt10_rev_ret.calculate"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.RecallAt10_rev_ret.calculate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sample_list</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
        <span class="n">model_output</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">],</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">ratk</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">flip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ratk</span></div></div>


<div class="viewcode-block" id="DetectionMeanAP"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.DetectionMeanAP">[docs]</a><span class="nd">@registry</span><span class="o">.</span><span class="n">register_metric</span><span class="p">(</span><span class="s2">&quot;detection_mean_ap&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DetectionMeanAP</span><span class="p">(</span><span class="n">BaseMetric</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Metric for calculating the detection mean average precision (mAP) using the COCO</span>
<span class="sd">    evaluation toolkit, returning the default COCO-style mAP@IoU=0.50:0.95</span>

<span class="sd">    **Key:** ``detection_mean_ap``</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset_json_files</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialization function detection mean AP (mAP)</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset_json_files (Dict): paths to the dataset (instance) json files</span>
<span class="sd">                for each dataset type and dataset name in the following format:</span>
<span class="sd">                ``{&#39;val/detection_coco&#39;: &#39;/path/to/instances_val2017.json&#39;, ...}``</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;detection_mean_ap&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">required_params</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;__prediction_report__&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_json_files</span> <span class="o">=</span> <span class="n">dataset_json_files</span>

<div class="viewcode-block" id="DetectionMeanAP.calculate"><a class="viewcode-back" href="../../../lib/modules/metrics.html#mmf.modules.metrics.DetectionMeanAP.calculate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">sample_list</span><span class="p">,</span> <span class="n">model_output</span><span class="p">,</span> <span class="n">execute_on_master_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate detection mean AP (mAP) from the prediction list and the dataset</span>
<span class="sd">        annotations. The function returns COCO-style mAP@IoU=0.50:0.95.</span>

<span class="sd">        Args:</span>
<span class="sd">            sample_list (SampleList): SampleList provided by DataLoader for</span>
<span class="sd">                                current iteration.</span>
<span class="sd">            model_output (Dict): Dict returned by model. This should contain</span>
<span class="sd">                                &quot;prediction_report&quot; field, which is a list of</span>
<span class="sd">                                detection predictions from the model.</span>
<span class="sd">            execute_on_master_only (bool): Whether to only run mAP evaluation on the</span>
<span class="sd">                                master node over the gathered detection prediction</span>
<span class="sd">                                (to avoid wasting computation and CPU OOM).</span>
<span class="sd">                                Default: True (only run mAP evaluation on master).</span>

<span class="sd">        Returns:</span>
<span class="sd">            torch.FloatTensor: COCO-style mAP@IoU=0.50:0.95.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># as the detection mAP metric is run on the entire dataset-level predictions,</span>
        <span class="c1"># which are *already* gathered from all notes, the evaluation should only happen</span>
        <span class="c1"># in one node and broadcasted to other nodes (to avoid CPU OOM due to concurrent</span>
        <span class="c1"># mAP evaluation)</span>
        <span class="kn">from</span> <span class="nn">mmf.utils.distributed</span> <span class="kn">import</span> <span class="n">broadcast_tensor</span><span class="p">,</span> <span class="n">is_master</span>
        <span class="kn">from</span> <span class="nn">mmf.utils.general</span> <span class="kn">import</span> <span class="n">get_current_device</span>
        <span class="kn">from</span> <span class="nn">pycocotools.coco</span> <span class="kn">import</span> <span class="n">COCO</span>
        <span class="kn">from</span> <span class="nn">pycocotools.cocoeval</span> <span class="kn">import</span> <span class="n">COCOeval</span>

        <span class="n">device</span> <span class="o">=</span> <span class="n">get_current_device</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">execute_on_master_only</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_master</span><span class="p">():</span>
            <span class="c1"># dummy mAP to be override in boardcasting</span>
            <span class="n">mAP</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="n">model_output</span><span class="o">.</span><span class="n">prediction_report</span>

            <span class="n">cocoGt</span> <span class="o">=</span> <span class="n">COCO</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataset_json_files</span><span class="p">[</span><span class="n">sample_list</span><span class="o">.</span><span class="n">dataset_name</span><span class="p">][</span>
                    <span class="n">sample_list</span><span class="o">.</span><span class="n">dataset_type</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">cocoDt</span> <span class="o">=</span> <span class="n">cocoGt</span><span class="o">.</span><span class="n">loadRes</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
            <span class="n">cocoEval</span> <span class="o">=</span> <span class="n">COCOeval</span><span class="p">(</span><span class="n">cocoGt</span><span class="p">,</span> <span class="n">cocoDt</span><span class="p">,</span> <span class="s2">&quot;bbox&quot;</span><span class="p">)</span>
            <span class="n">cocoEval</span><span class="o">.</span><span class="n">evaluate</span><span class="p">()</span>
            <span class="n">cocoEval</span><span class="o">.</span><span class="n">accumulate</span><span class="p">()</span>
            <span class="n">cocoEval</span><span class="o">.</span><span class="n">summarize</span><span class="p">()</span>
            <span class="n">mAP</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">cocoEval</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">execute_on_master_only</span><span class="p">:</span>
            <span class="n">mAP</span> <span class="o">=</span> <span class="n">broadcast_tensor</span><span class="p">(</span><span class="n">mAP</span><span class="p">,</span> <span class="n">src</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mAP</span></div></div>
</pre></div>

             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, Facebook AI Research.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
         <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
         <script src="../../../_static/jquery.js"></script>
         <script src="../../../_static/underscore.js"></script>
         <script src="../../../_static/doctools.js"></script>
     

  

  <script type="text/javascript" src="../../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <!-- Begin Footer -->


  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://mmf.sh/" class="footer-logo"></a>
      </div>
      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://mmf.sh/">MMF</a></li>
            <li><a href="https://mmf.sh/docs">Get Started</a></li>
            <li><a href="https://mmf.sh/docs/getting_started/features">Features</a></li>
            <li><a href="https://github.com/facebookresearch/master/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="">Resources</a></li>
            <li><a href="https://mmf.sh/docs">Docs</a></li>
            <li><a href="https://mmf.sh/api">API</a></li>
            <li><a href="https://github.com/facebookresearch/master/issues" target="_blank">Github Issues</a></li>
          </ul>
        </div>
        </div>
      </div>
    </div>
  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebook’s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../../../_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://mmf.sh/" aria-label="MMF"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://mmf.sh/docs">Get Started</a>
          </li>

          <li>
            <a href="https://mmf.sh/docs/getting_started/features">Features</a>
          </li>

          <li>
            <a href="https://mmf.sh/docs">Docs</a>
          </li>

          <li class="active">
            <a href="https://mmf.sh/api">API</a>
          </li>
          <li>
            <a href="https://github.com/facebookresearch/mmf">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>